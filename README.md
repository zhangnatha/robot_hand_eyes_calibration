# 2D/3D 相机 → 机器人手眼标定项目 (Python)
本项目为工业视觉与机器人协同开发提供了一套完善的标定与检测方案。支持多种 2D 及 3D 相机的手眼手动标定（眼在手上/眼在手外）

**核心亮点**：
*   **全面支持**：完整支持全部 **12 种欧拉角旋转顺序**及内外旋设置，适配全球主流工业机器人（如 KUKA, Fanuc, ABB, UR 等）。
*   **UR 机器人原生支持**：特别支持 UR 机器人的 **旋转向量 (Rotation Vector / Axis-Angle)** 格式，无需手动转换。
*   **纯 Python 实现**：基于 NumPy, OpenCV, SciPy 构建，代码简洁，易于集成与二次开发。
*   **高精度算法**：内置高精度手眼标定算法（基于非线性优化），支持标定板、标定球等多种方式。

---

## 支持的标定方式

### 1. 2D 相机标定
适用于相机与物体拍照距离恒定、物体在平面内运动的场景。
*   **4点插针标定 (Four-Point Pin)**：
    *   **原理**：利用 4 组 (像素点 -> 机器人平面坐标) 建立仿射变换。
    *   **应用**：快速实现像素坐标到机器人工作空间的平面转换。
*   **12点标定 (Twelve-Point Calibration)**：
    *   **原理**：由 9 点仿射变换（映射平移、旋转及缩放）与 3 点圆周运动拟合（求解旋转中心）组成。
    *   **特点**：可精确解耦机器人末端工具（TCP）的旋转中心。

### 2. 3D 相机标定
适用于空间 6DoF 位姿解算。
*   **基于标定球 (Ball-based)**：
    *   **原理**：通过在不同位置采集标定球心在相机坐标系下的 (x, y, z) 及其对应的机器人末端位姿，求解手眼矩阵。
*   **基于标定板 (Board Image)**：
    *   **原理**：利用标定板（棋盘格/圆点阵列）图片的已知几何特征，通过 PnP 算法解算出标定板在相机下的位姿，结合机器人位姿求解手眼矩阵。

### 3. 欧拉角约定
在 3D 手眼标定中，**欧拉角顺序与参考系设置至关重要**。本项目提供 `RPY` 类完整支持：
*   **KUKA**: ZYX 外旋
*   **Fanuc**: XYZ 外旋
*   **UR (Universal Robots)**: `ROT_VECTOR` (旋转向量)
*   **其他**: 支持任意 12 种轴序组合

---

## 环境搭建与运行

### 1. 依赖安装
本项目无需编译，直接安装 Python 依赖即可运行：
```bash
# 推荐使用 numpy<2.0 以确保与 opencv-python 的最佳兼容性
pip install "numpy<2.0" scipy opencv-python
```

### 2. 运行标定
在项目根目录下运行主程序：
```bash
python3 python/calib.py
```
程序会自动读取 `assert/camera/` 目录下的测试图像和预设的机器人位姿数据进行演示。

---

## 标定结果示例与说明
> 提示：主程序 calib.cpp 中提供了多个宏（如 RUN_INTRINSIC, RUN_HAND_EYE_3D_BOARD_IMG 等）, 您可以通过修改这些宏的开关来选择性地执行特定的标定任务.

运行程序后，控制台会依次输出各模块的标定结果。以下为各功能的完整输出截取与含义解析：

### 1. 内参标定 (Intrinsic Calibration)
```text
====================================================================
   Category 1: Intrinsic Calibration
====================================================================

进度: 20/20  有效: 11
第一次标定成功！RMS = 0.1875
内参: 
[3496.8753802687124, 0.0, 1599.4413379396437;
 0.0, 3497.1206305009873, 1065.4680148610782;
 0.0, 0.0, 1.0]
畸变: 
[-0.03033851239088802, -0.08234400905952395, 0.0007343622168629118, 0.00062188149612819, 0.6601234592369354]
[SUCCESS] Intrinsic calibration success!
```
*   **含义解析**：
    *   **RMS (0.1875)**：重投影均方根误差 (像素单位)，通常工业级相机标定该值应 **< 0.2**。
    *   **内参矩阵**：包含焦距 fx, fy 和主点 cx, cy。
    *   **畸变系数**：[k1, k2, p1, p2, k3]，用于校正镜头畸变。

### 2. 3D 基于标定板的手眼标定 (Board Image)
此过程包含两个阶段：首先进行第二次内参优化与 PnP 解算，然后进行手眼矩阵求解。
```text
====================================================================
   Category 2: 3D Camera Hand-Eye Calibration - Based on Board Image
====================================================================
[INFO] Starting hand-eye calibration...
进度: 20/20  有效: 11
第二次标定成功！RMS = 0.2289
...
[SUCCESS] 3D Hand-Eye Calibration successful!
[INFO] Index | Robot(x,y,z,rx,ry,rz) | Marker(x,y,z) | Error
--------------------------------------------------------------
  0 |   211.8920,  -415.1030,  -536.2130, ... |   -48.4190,   -39.0447,   182.0946 |     0.1560
  1 |   217.3530,  -412.2230,  -530.4370, ... |   -45.1920,   -33.7616,   175.3189 |     0.0863
...
[SUCCESS] 3D Hand-Eye Calibration successful! Avg Error: 0.131100, Max: 0.173000, Min: 0.029100
[INFO] hand_eyes Homogeneous Matrix (Eigen format):
  -0.1921  0.9799  0.0544  206.9900
  0.9810  0.1932  -0.0166  -331.5936
  -0.0268  0.0502  -0.9984  -426.7618
  0.0000  0.0000  0.0000  1.0000

[RESULT] hand_eyes (Pose3D format):
206.9900, -331.5936, -426.7618, 177.1207, 1.5365, 101.0783
```
*   **含义解析**：
    *   **Avg Error (0.1311)**：手眼矩阵闭环后的物理平均误差（mm）。**0.13mm** 表示精度极佳。
    *   **Pose3D format**：最终输出的手眼变换关系 (x, y, z, rx, ry, rz)，其中平移单位为 mm，旋转为度。
    *   **hand_eyes**：眼在手上-相机坐标系到机器人末端坐标系的转换关系, 眼在手外-相机坐标系到机器人基坐标系的转换关系.

### 3. 2D 4点插针标定 (4-Point Pin)
最基础的平移+旋转+缩放映射.

```text
=====================================================================
   Category 3: 2D Camera Hand-Eye Calibration - 4-Point Pin                                                                                                                                                                
=====================================================================                                                                                                                                                      
[INFO] hand_eyes Homogeneous Matrix (2x3):
[0.002497689025360392, -0.2892431098781214, 1112.020940991345;
 -0.2892287874796049, -0.001915924547197932, 1477.02187947132]

[VERIFY] Four-point pin verification: Image(2035.0000,1093.0000) → Robot(800.9610, 886.3472)
```

*   **含义解析**：
    *   **2x3 矩阵**：仿射变换矩阵, 描述了像素坐标 (u, v) 到机器人坐标 (x, y) 的映射.
    *   **Verification**：验证点. 输入特定的像素位置, 计算出机器人的物理坐标, 用于快速检查精度.

### 4. 2D 12点标定 (12-Point)
```text
====================================================================
   Category 4: 2D Camera Hand-Eye Calibration - 12-Point                                                                                                                                                                   
====================================================================                                                                                                                                                       

[INFO] Index | Robot(dx,dy,rz) | Image(x,y,theta) | Error
--------------------------------------------------------------
  0 |     0.0000,     0.0000,     0.0000 |  1188.0000,   468.0000,     0.0000 |     0.0000
  1 |     0.0000,    30.0000,     0.0000 |  1173.0000,   467.0000,     0.0000 |    19.9885
  2 |    30.0000,    30.0000,     0.0000 |  1195.0000,   464.0000,     0.0000 |    48.8019
  3 |    30.0000,     0.0000,     0.0000 |  1320.0000,   474.0000,     0.0000 |     5.9699
  4 |    30.0000,   -30.0000,     0.0000 |  1249.0000,   593.0000,     5.0000 |    46.7405
  5 |     0.0000,   -30.0000,     0.0000 |  1292.0000,   545.0000,     7.0000 |    30.6642
  6 |   -30.0000,   -30.0000,     0.0000 |  1346.0000,   632.0000,     6.0000 |    43.3651
  7 |   -30.0000,     0.0000,     0.0000 |  1439.0000,   520.0000,     5.0000 |    53.1678
  8 |   -30.0000,    30.0000,     0.0000 |  1482.0000,   595.0000,     4.0000 |     5.9699
  9 |     0.0000,     0.0000,   -10.0000 |  1329.0000,   437.0000,     6.0000 |     0.0000
 10 |     0.0000,     0.0000,     0.0000 |  1239.0000,   472.0000,     0.0000 |     0.0000
 11 |     0.0000,     0.0000,    10.0000 |  1420.0000,   550.0000,   -14.0000 |     0.0000
[SUCCESS] 2D Twelve-point Calibration successful!
[INFO] Transform Pose (2x3 Affine Matrix):
0.1883, -0.3319, -68.3544
-0.0553, 0.2670, -59.2405

[INFO] Circle Fitting Result: 
center=(1317.1327, 539.6984), R=(103.3818)

[RESULT] TCP Rotation Center (relative to registration point): 129.1327, 71.6984
[VERIFY] Twelve-point verification: Image(1188.0000,468.0000) -> Robot(0.0000, 0.0000, 0.0000°)
```
*   **含义解析**：
    * **Error**：每个采样点的计算误差（像素单位）.
    *   **Transform Pose**：2D 平面的仿射变换矩阵。
    *   **TCP Rotation Center**：解算出的机器人末端旋转中心相对于拍照点的偏移量。
    *   **Verification**：验证点. 输入特定的像素位置以及角度, 计算出机器人的物理坐标以及旋转, 用于快速检查精度.

### 5. 3D 基于标定球 (Ball-based)
```text
====================================================================
   Category 5: 3D Camera Hand-Eye Calibration - Based on Ball Center XYZ                                                                                                                                                   
====================================================================                                                                                                                                                       


[INFO] Index | Robot(x,y,z,rx,ry,rz) | Marker(x,y,z) | Error
--------------------------------------------------------------
  0 | -1223.0700,  1493.1400,   774.3510,  -172.6910,   -14.0740,   170.7250 |  -107.0000,    -2.2500,   632.7500 |     3.0767
  1 | -1105.2500,  1370.0700,   774.3030,  -171.2130,   -18.8400,   153.0760 |    -3.7500,   -39.2500,   528.0000 |     2.5035
  2 | -1064.5600,  1424.3100,   808.0860,   166.7360,   -18.0350,   160.8740 |    48.7500,   -37.0000,   627.5000 |     2.8291
  3 | -1154.6400,  1396.6700,   780.3820,   168.4160,   -13.8180,   164.4820 |   -29.7500,   -14.2500,   580.2500 |     2.3280
  4 | -1099.2800,  1471.4400,   637.9320,  -170.2010,    -0.8750,   160.1770 |    46.7500,   108.7500,   584.5000 |     3.5364
  5 | -1215.1800,  1368.7200,   656.1080,  -173.2380,    14.4140,   173.6310 |   -19.5000,    59.7500,   490.7500 |     0.9278
  6 | -1148.4500,  1422.8000,   730.7530,  -176.3720,    10.7350,   163.3650 |    21.0000,     2.5000,   563.0000 |     1.5755
  7 | -1132.7600,  1358.1100,   775.3240,   178.9240,     4.6490,   171.3760 |    38.7500,   -47.2500,   525.7500 |     5.1851
  8 | -1231.2400,  1314.0300,   762.0050,   169.6000,   -10.5350,   173.2340 |   -89.2500,   -16.7500,   487.5000 |     3.4075
  9 | -1186.7200,  1408.2200,   682.3400,   174.9600,    -4.6410,   165.9100 |   -36.0000,    78.2500,   554.2500 |     4.8374
 10 | -1106.2600,  1441.8000,   686.1170,   179.9560,     0.5700,   152.8260 |    39.2500,    65.5000,   575.5000 |     2.4741
[SUCCESS] 3D Ball-based Calibration successful! Avg Error: 2.970991
[INFO] hand_eyes Homogeneous Matrix (Eigen format):
  0.9933  -0.0585  0.0994  -1182.4047
  -0.0824  0.2432  0.9665  818.1944
  -0.0807  -0.9682  0.2367  497.1121
  0.0000  0.0000  0.0000  1.0000

[RESULT] hand_eyes (Pose3D format):
-1182.4047, 818.1944, 497.1121, -76.2616, 4.6280, -4.7413
```
*   **含义解析**：
    *   适用于无纹理或大视场场景，通过识别球心进行标定。
    *   **Error**：由于球心识别受光照影响，误差通常在毫米级别。

---

## 代码结构

```text
python/
├── calib.py                  # 主程序入口
├── README.md                 # 项目文档
└── src/
    ├── common/
    │   ├── rpy.py            # 欧拉角与旋转矩阵转换工具
    │   └── transforms.py     # 位姿数据结构 (Pose3D)
    └── calibration/
        ├── robot_camera_calibrator_3d.py  # 核心手眼标定算法
        ├── board_image_calibrator.py      # 标定板标定流程
        ├── intrinsic_calibrator.py        # 相机内参标定
        ├── twelve_point_calibrator.py     # 2D 12点法标定
        └── ball_calibrator.py             # 3D 球标定
```

## 注意事项

1.  **标定板尺寸**：请务必确认 `calib.py` 中 `cfg.interval_mm` (如圆心距或方格边长) 与实际打印的标定板尺寸一致。
2.  **坐标系一致性**：请确保输入的机器人位姿格式（如 XYZ 外旋）与代码中设置的 `rpy_type` 一致，否则会导致巨大的标定误差。
3.  **数据采集**：进行 3D 标定时，务必包含充分的 **旋转姿态** 变化，仅有平移运动无法解算出唯一的手眼矩阵。
